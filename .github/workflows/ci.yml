name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [workflow-service]

    steps:
      - uses: actions/checkout@v4

      # ----------------------------
      # Setup Go (1.24 + fallback)
      - name: Set up Go 1.24
        id: go124
        uses: actions/setup-go@v5
        continue-on-error: true
        with:
          go-version: "1.24"

      - name: Set up Go 1.22 (fallback)
        if: steps.go124.outcome == 'failure'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - run: go version

      # ----------------------------
      # Cache (อิง service เท่านั้น)
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(format('services/{0}/go.sum', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-go-

      # ----------------------------
      # Download deps (FIXED)
      - name: Download dependencies
        run: go mod download -C services/${{ matrix.service }}

      # ----------------------------
      # Test
      - name: Run tests
        run: go test ./... -v -C services/${{ matrix.service }}

      # ----------------------------
      # Build
      - name: Build binary
        run: go build -v ./cmd/main.go -C services/${{ matrix.service }}
